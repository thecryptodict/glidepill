<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Cap PFP Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f4f4;
        }
        #pfp-container {
            border: 2px solid #ccc;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        button, input[type="file"] {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        #upload-btn, #download-btn {
            background-color: #007bff;
            color: white;
        }
        #upload-btn:hover, #download-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <h1>PFP Generator: Mint Green P-Cap</h1>

    <div class="controls">
        <input type="file" id="upload-pfp" accept="image/*" style="display: none;">
        <button id="upload-btn" onclick="document.getElementById('upload-pfp').click()">Upload Your PFP</button>
        <button id="download-btn">Download Final PFP</button>
    </div>

    <div id="pfp-container">
        <canvas id="pfp-canvas" width="400" height="400" style="border: 1px solid #000;"></canvas>
    </div>

    <p>
        **Instructions:**
        1. Click "Upload Your PFP" and select an image.
        2. Use the controls (dots) on the cap to **drag, rotate, and scale** it to fit your image.
        3. Click "Download Final PFP".
    </p>

    <script>
        // Initialize Fabric.js Canvas
        const canvas = new fabric.Canvas('pfp-canvas');
        const CANVAS_SIZE = 400; 

        // --- IMAGE ASSETS (SVG Paths) ---

        // The Bat Symbol (Logo is unchanged and correct)
        const batPath = 'M9.90672 16C12.1452 16 15.669 15.2444 18.0847 13.7556V6.8H10.1948V9.35556H15.4252V12C14.1398 12.9333 11.8792 13.4444 9.90672 13.4444C5.98392 13.4444 2.65952 11.2889 2.65952 8C2.65952 4.48889 5.98392 2.55556 9.90672 2.55556C11.7019 2.55556 14.4057 3 16.2231 4.62222V1.66667C14.583 0.6 12.0343 0 9.90672 0C4.16658 0 0 3.24444 0 8C0 12.7556 4.16658 16 9.90672 16ZM20.301 15.7778H33.5986V13.4444H22.9605V0.222222H20.301V15.7778ZM35.8149 15.7778H38.4744V0.222222H35.8149V15.7778ZM40.6907 15.7778H48.913C53.6559 15.7778 56.9803 13.7333 56.9803 8C56.9803 2.71111 53.6559 0.222222 48.913 0.222222H40.6907V15.7778ZM43.3502 2.77778H48.913C52.1045 2.77778 54.3207 4.15556 54.3207 8C54.3207 11.8444 52.1045 13.2222 48.913 13.2222H43.3502V2.77778ZM58.7754 15.7778H72.2947V13.2222H61.435V9.22222H71.8736V6.77778H61.435V2.77778H72.206V0.222222H58.7754V15.7778ZM74.4223 15.7778H77.0818V8.84444L87.055 15.7778H91.1994L81.2927 8.88889H84.5728C88.3626 8.88889 89.4707 6.93333 89.4707 4.55556C89.4707 2.17778 88.3626 0.222222 84.5728 0.222222H74.4223V15.7778ZM77.0818 6.33333V2.77778H84.4398C86.2572 2.77778 86.8112 3.62222 86.8112 4.55556C86.8112 5.6 86.2572 6.33333 84.4398 6.33333H77.0818ZM113.122 14H113.121C113.096 9.72419 109.668 6.26569 105.443 6.26569C103.698 6.26569 102.09 6.85501 100.801 7.84785C102.254 5.31115 104.445 3.26163 107.075 2C108.669 3.53927 110.826 4.48429 113.202 4.48429C115.575 4.48429 117.731 3.54093 119.325 2.00404C122.027 3.30226 124.264 5.43216 125.714 8.06745C124.382 6.94249 122.669 6.26568 120.8 6.26568C116.574 6.26568 113.146 9.72418 113.122 14Z';

        // FINAL UPDATED CAP PATH: Focuses on the baseball cap's rounded dome and curved brim
        const capPath = 'M 10,70 C 5,60 0,20 50,0 C 100,20 95,60 90,70 L 80,75 C 70,90 30,90 20,75 L 10,70 Z M 15,70 C 15,80 85,80 85,70 L 15,70 Z';

        // --- FUNCTIONS ---

        function addCapAndLogo() {
            // 1. Add the Mint Green Cap
            const cap = new fabric.Path(capPath, {
                fill: '#98F7C6', // Mint Green color code
                scaleX: 3.2, 
                scaleY: 2.5, // Increased vertical scale slightly for better coverage
                top: 100,
                left: 100,
                originX: 'center',
                originY: 'center',
                selectable: true,
                hasControls: true,
                name: 'cap'
            });

            // 2. Add the Black Bat Logo
            const logo = new fabric.Path(batPath, {
                fill: 'black', 
                scaleX: 2.5, 
                scaleY: 2.5,
                top: 110, 
                left: 150,
                originX: 'center',
                originY: 'center',
                selectable: true,
                hasControls: true,
                name: 'logo'
            });
            
            // Adjust the logo position relative to the cap (center it on the dome)
            logo.set({
                top: cap.top + (cap.getScaledHeight() * 0.1), // Slightly down from the center for the dome
                left: cap.left,
                originX: 'center',
                originY: 'center'
            });


            // Group them so they move together initially
            const group = new fabric.Group([cap, logo], {
                left: CANVAS_SIZE / 2,
                top: CANVAS_SIZE / 2,
                originX: 'center',
                originY: 'center',
                hasControls: true,
                lockScalingFlip: true, 
                name: 'cap_group'
            });

            canvas.add(group);
            canvas.setActiveObject(group); 
            canvas.renderAll();
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(f) {
                const data = f.target.result;
                fabric.Image.fromURL(data, function(img) {
                    
                    // Remove any previous background image
                    canvas.getObjects().filter(obj => obj.name === 'pfp_background').forEach(obj => canvas.remove(obj));

                    // Scale the uploaded image to fit the canvas and center it
                    img.scaleToWidth(CANVAS_SIZE);
                    if (img.getScaledHeight() > CANVAS_SIZE) {
                        img.scaleToHeight(CANVAS_SIZE);
                    }
                    
                    img.set({
                        top: CANVAS_SIZE / 2,
                        left: CANVAS_SIZE / 2,
                        originX: 'center',
                        originY: 'center',
                        selectable: false, 
                        evented: false,
                        name: 'pfp_background'
                    });

                    // Add the image to the canvas at the back
                    canvas.add(img);
                    canvas.sendToBack(img);
                    canvas.renderAll();

                    // Add the cap/logo if not already present
                    if (!canvas.getObjects().find(obj => obj.name === 'cap_group')) {
                        addCapAndLogo();
                    }
                });
            };
            reader.readAsDataURL(file);
        }

        function downloadImage() {
            // Remove selection borders and controls for the final image
            canvas.discardActiveObject();
            canvas.renderAll();

            // Generate the final image data URL
            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1.0,
                width: CANVAS_SIZE,
                height: CANVAS_SIZE
            });

            // Create a temporary link element to trigger the download
            const link = document.createElement('a');
            link.download = 'custom_pfp_cap.png';
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- EVENT LISTENERS ---

        document.getElementById('upload-pfp').addEventListener('change', handleImageUpload);
        document.getElementById('download-btn').addEventListener('click', downloadImage);

        // Initial setup for the canvas (optional background color)
        canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
        canvas.renderAll();

    </script>

</body>
</html>
